<div class="comentarios-container">

  @if (comentarios.length === 0) {
    <p class="no-comentarios">No hay comentarios para mostrar.</p>
  } @else {
    @for (comentario of comentarios; track comentario.id) {
      <article class="comentario-card" [class.reported]="comentario.reportada">

        <div class="comentario-header">
          <div class="creador-info" (click)="irAPerfilContratador(comentario.idCreador)">
            <img
              [src]="getImagenPerfil(comentario.idCreador) || 'public/avatar.png'"
              [alt]="'Foto de ' + (getUsuarioById(comentario.idCreador)?.nombreCompleto || 'Usuario')"
              class="creador-foto"
              loading="lazy"
            />
            <div class="usuario-details">
              <h3 class="nombre-creador">
                {{ getUsuarioById(comentario.idCreador)?.nombreCompleto || 'Anónimo' }}
              </h3>
              <span class="puntaje">Puntaje: {{ comentario.puntaje }}/5</span>
            </div>
          </div>
        </div>

        <div class="comentario-content">
          <p>{{ comentario.contenido }}</p>
          @if (comentario.reportada) {
            <small class="text-warning">
              <em>Este comentario fue reportado.</em>
            </small>
          }
        </div>

        @if (usuAdm.permisos === 'c' || usuAdm.permisos === 'cp') {
          @if (!comentario.controlado) { <!--El usuario administrador no puede borrar si está controlado-->
            <div class="motivo-container">
              <textarea
                [formControl]="motivoControls[comentario.id!]"
                placeholder="Motivo de eliminación (50-200 caracteres, sin espacios en blanco)"
                class="motivo-input"
                rows="3"
              ></textarea>

              @if (motivoControls[comentario.id!].touched && motivoControls[comentario.id!].invalid) {
                <small class="error-text">
                  @if (motivoControls[comentario.id!].errors?.['required']) {
                    El motivo es obligatorio.
                  } @else if (motivoControls[comentario.id!].errors?.['minlength']) {
                    Mínimo 50 caracteres.
                  } @else if (motivoControls[comentario.id!].errors?.['maxlength']) {
                    Máximo 200 caracteres.
                  } @else if (motivoControls[comentario.id!].errors?.['whitespace']) {
                    No puede contener solo espacios.
                  }
                </small>
              }
            </div>

            <div class="comentario-actions" (click)="$event.stopPropagation()">
              <button
                class="delete-button"
                (click)="eliminar(comentario.id)"
                [disabled]="motivoControls[comentario.id!].invalid"
              >
                Eliminar
                <span class="action-label">Eliminar</span>
              </button>

              @if (comentario.reportada) {
                <button
                  class="approve-button"
                  (click)="aprobar(comentario)"
                >
                  Aprobar
                </button>
              }
            </div>

          } @else {
            <div class="controlado-label">
              <span class="reported-label">Comentario controlado</span>
            </div>
          }
        }
      </article>
    }
  }
</div>

